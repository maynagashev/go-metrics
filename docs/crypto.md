# Асимметричное шифрование в go-metrics

В этом документе описывается, как использовать асимметричное шифрование для защиты данных, передаваемых между агентом и сервером.

## Общая информация

Асимметричное шифрование использует пару ключей:

- **Публичный ключ** - используется для шифрования данных. Этот ключ можно свободно распространять.
- **Приватный ключ** - используется для расшифровки данных. Этот ключ должен храниться в секрете.

В нашей системе:

- **Агент** использует публичный ключ для шифрования метрик перед отправкой на сервер.
- **Сервер** использует приватный ключ для расшифровки полученных метрик.

## Ограничения RSA шифрования и их решение

RSA может шифровать только небольшие объемы данных. Для ключа размером 2048 бит максимальный размер данных, которые можно зашифровать, составляет около 190 байт. 

Для решения этой проблемы мы предоставляем две стратегии:

1. **Базовое RSA шифрование** (`Encrypt` и `Decrypt`) - для небольших данных (до 190 байт для ключа 2048 бит).
2. **Шифрование больших данных** (`EncryptLargeData` и `DecryptLargeData`) - для данных любого размера, которые автоматически разбиваются на части, шифруются по отдельности и затем объединяются.

## Генерация ключей

Для генерации пары ключей используйте утилиту `keygen`:

```bash
# Сборка утилиты
go build -o bin/keygen cmd/keygen/main.go

# Генерация ключей с параметрами по умолчанию
./bin/keygen

# Генерация ключей с указанием путей и размера ключа
./bin/keygen -private=private.pem -public=public.pem -bits=4096
```

По умолчанию утилита создаст:

- `private.pem` - приватный ключ для сервера (в формате PKCS#1)
- `public.pem` - публичный ключ для агента (в формате X.509 сертификата)
- Размер ключа по умолчанию: 2048 бит

## Формат ключей

Утилита `keygen` генерирует:

- Приватный ключ в формате PKCS#1 (PEM-блок с типом "RSA PRIVATE KEY")
- Публичный ключ в формате X.509 сертификата (PEM-блок с типом "CERTIFICATE")

Сертификат X.509 содержит дополнительную информацию о ключе, такую как:

- Срок действия (10 лет с момента создания)
- Информация о владельце (организация "go-metrics", страна "RU")
- Разрешенные IP-адреса (127.0.0.1 и ::1)
- Разрешенные способы использования ключа (цифровая подпись, клиентская и серверная аутентификация)

## Настройка агента

Для включения шифрования на агенте:

```bash
# Запуск с указанием пути к публичному ключу
./bin/agent -crypto-key=public.pem

# Или через переменную окружения
CRYPTO_KEY=public.pem ./bin/agent
```

## Настройка сервера

Для включения расшифровки на сервере:

```bash
# Запуск с указанием пути к приватному ключу
./bin/server -crypto-key=private.pem

# Или через переменную окружения
CRYPTO_KEY=private.pem ./bin/server
```

## Как это работает

1. Агент собирает метрики и сериализует их в JSON.
2. Если указан путь к публичному ключу, агент шифрует данные:
   - Если данные небольшие (до 190 байт для ключа 2048 бит), используется функция `Encrypt`
   - Если данные большие, используется функция `EncryptLargeData`, которая разбивает данные на части, шифрует каждую часть отдельно и объединяет результаты
   - Зашифрованные данные отправляются на сервер с заголовком `Content-Encrypted: true`
3. Сервер получает данные и проверяет заголовок `Content-Encrypted`.
4. Если данные зашифрованы и указан путь к приватному ключу, сервер расшифровывает данные:
   - Если данные были зашифрованы с помощью `Encrypt`, используется функция `Decrypt`
   - Если данные были зашифрованы с помощью `EncryptLargeData`, используется функция `DecryptLargeData`
5. Сервер обрабатывает расшифрованные данные как обычно.

## Безопасность

- Храните приватный ключ в безопасном месте.
- Не передавайте приватный ключ по незащищенным каналам.
- Регулярно обновляйте ключи для повышения безопасности.
- Размер ключа влияет на безопасность: 2048 бит считается достаточным для большинства применений, 4096 бит обеспечивает более высокий уровень безопасности.

## Примечания

- Шифрование увеличивает размер передаваемых данных и требует дополнительных вычислительных ресурсов.
- Если ключи не указаны, шифрование не используется, и данные передаются в открытом виде.
- Шифрование работает вместе с сжатием (gzip) и подписью (HMAC-SHA256), если они включены.
- Шифрование работает вместе с сжатием (gzip) и подписью (HMAC-SHA256), если они включены.
- Если ключи не указаны, шифрование не используется, и данные передаются в открытом виде.
- Шифрование работает вместе с сжатием (gzip) и подписью (HMAC-SHA256), если они включены.
- 