# Внедрение gRPC в проект go-metrics

## Введение

Данный документ описывает план внедрения протокола gRPC для обмена данными между агентом и сервером в проекте go-metrics. Реализация gRPC позволит улучшить производительность, надежность и расширяемость системы сбора метрик.

## Текущая архитектура

В текущей реализации агент и сервер обмениваются данными по HTTP протоколу:
- Агент собирает метрики и отправляет их на сервер через HTTP POST запросы
- Сервер принимает метрики через HTTP эндпоинты и сохраняет их в хранилище
- Поддерживается сжатие данных (gzip), шифрование (RSA), подпись запросов (HMAC-SHA256)
- Реализована проверка IP-адресов агентов через заголовок X-Real-IP

## План внедрения gRPC

### 1. Определение Proto-файлов

Создадим proto-файлы, описывающие структуру данных и сервисы:

```proto
// proto/metrics.proto
syntax = "proto3";

package metrics;

option go_package = "github.com/maynagashev/go-metrics/internal/grpc/pb";

// Тип метрики
enum MetricType {
  GAUGE = 0;
  COUNTER = 1;
}

// Метрика
message Metric {
  string name = 1;
  MetricType type = 2;
  optional int64 delta = 3;
  optional double value = 4;
}

// Запрос на обновление метрики
message UpdateRequest {
  Metric metric = 1;
}

// Запрос на пакетное обновление метрик
message UpdateBatchRequest {
  repeated Metric metrics = 1;
}

// Запрос на получение значения метрики
message GetValueRequest {
  string name = 1;
  MetricType type = 2;
}

// Ответ с метрикой
message MetricResponse {
  Metric metric = 1;
}

// Ответ на пакетное обновление
message UpdateBatchResponse {
  bool success = 1;
  string error = 2;
}

// Запрос на проверку соединения с БД
message PingRequest {}

// Ответ на проверку соединения с БД
message PingResponse {
  bool success = 1;
  string error = 2;
}

// Сервис метрик
service MetricsService {
  // Обновление одиночной метрики
  rpc Update(UpdateRequest) returns (MetricResponse);
  
  // Пакетное обновление метрик
  rpc UpdateBatch(UpdateBatchRequest) returns (UpdateBatchResponse);
  
  // Получение значения метрики
  rpc GetValue(GetValueRequest) returns (MetricResponse);
  
  // Проверка соединения с БД
  rpc Ping(PingRequest) returns (PingResponse);
  
  // Потоковая отправка метрик (клиент -> сервер)
  rpc StreamMetrics(stream Metric) returns (UpdateBatchResponse);
}
```

Для генерации Go-кода из proto-файлов используется команда:

```bash
make proto
```

Эта команда выполняет следующие действия:
1. Создает директорию `internal/grpc/pb` (если она не существует)
2. Генерирует Go-код из proto-файлов с помощью protoc
3. Перемещает сгенерированные файлы в директорию `internal/grpc/pb`

### 2. Параметры конфигурации gRPC

#### Для сервера:

Добавим следующие параметры в конфигурацию сервера:

1. **Флаги командной строки:**
   - `-grpc-address` - адрес и порт для gRPC сервера (по умолчанию "localhost:9090")
   - `-grpc-enabled` - флаг включения gRPC сервера (по умолчанию false)
   - `-grpc-max-conn` - максимальное количество одновременных соединений (по умолчанию 100)
   - `-grpc-timeout` - таймаут для gRPC запросов в секундах (по умолчанию 5)

2. **Переменные окружения:**
   - `GRPC_ADDRESS` - адрес и порт для gRPC сервера
   - `GRPC_ENABLED` - флаг включения gRPC сервера
   - `GRPC_MAX_CONN` - максимальное количество одновременных соединений
   - `GRPC_TIMEOUT` - таймаут для gRPC запросов в секундах

3. **JSON-конфигурация:**
   ```json
   {
     "grpc_address": "localhost:9090",
     "grpc_enabled": true,
     "grpc_max_conn": 100,
     "grpc_timeout": 5
   }
   ```

#### Для агента:

Добавим следующие параметры в конфигурацию агента:

1. **Флаги командной строки:**
   - `-grpc-address` - адрес и порт gRPC сервера (по умолчанию "localhost:9090")
   - `-grpc-enabled` - флаг использования gRPC вместо HTTP (по умолчанию false)
   - `-grpc-timeout` - таймаут для gRPC запросов в секундах (по умолчанию 5)
   - `-grpc-retry` - количество повторных попыток при ошибке (по умолчанию 3)

2. **Переменные окружения:**
   - `GRPC_ADDRESS` - адрес и порт gRPC сервера
   - `GRPC_ENABLED` - флаг использования gRPC вместо HTTP
   - `GRPC_TIMEOUT` - таймаут для gRPC запросов в секундах
   - `GRPC_RETRY` - количество повторных попыток при ошибке

3. **JSON-конфигурация:**
   ```json
   {
     "grpc_address": "localhost:9090",
     "grpc_enabled": true,
     "grpc_timeout": 5,
     "grpc_retry": 3
   }
   ```

### 3. Реализация gRPC сервера

1. **Создание gRPC сервера:**
   - Реализация интерфейса `MetricsService` из proto-файла
   - Запуск gRPC сервера параллельно с HTTP сервером
   - Обработка запросов на обновление метрик, получение значений и проверку соединения с БД

2. **Интеграция с существующим хранилищем:**
   - Использование существующего интерфейса `storage.Repository` для работы с метриками
   - Адаптация gRPC запросов к существующим методам хранилища
   - Сгенерированный код размещается в директории `internal/grpc/pb`

3. **Реализация перехватчиков (interceptors):**
   - Логирование запросов и ответов
   - Проверка подписи запросов (аналог HMAC-SHA256 для HTTP)
   - Обработка ошибок и повторных попыток

4. **Реализация потоковой обработки метрик:**
   - Прием потока метрик от агента
   - Группировка метрик в пакеты для эффективного сохранения
   - Обработка ошибок и завершения потока

### 4. Реализация gRPC клиента (агента)

1. **Создание gRPC клиента:**
   - Реализация клиента для `MetricsService`
   - Отправка метрик через gRPC вместо HTTP
   - Обработка ошибок и повторные попытки

2. **Интеграция с существующим агентом:**
   - Создание фабрики клиентов (HTTP или gRPC) в зависимости от конфигурации
   - Адаптация существующих методов отправки метрик для работы с gRPC

3. **Реализация перехватчиков (interceptors):**
   - Логирование запросов и ответов
   - Добавление подписи запросов
   - Обработка ошибок и повторных попыток

4. **Реализация потоковой отправки метрик:**
   - Открытие потока для отправки метрик
   - Отправка метрик в поток по мере их сбора
   - Обработка ошибок и закрытие потока

### 5. Использование возможностей gRPC

1. **Сжатие данных:**
   - Использование встроенного сжатия gRPC (gzip)
   - Сервер автоматически обрабатывает сжатые запросы благодаря импорту пакета `google.golang.org/grpc/encoding/gzip`
   - Сжатие данных включено по умолчанию для всех gRPC запросов
   - Использование опции `grpc.UseCompressor(gzip.Name)` при каждом вызове методов gRPC

2. **Шифрование:**
   - Использование TLS для шифрования соединения
   - Поддержка существующих ключей шифрования

3. **Аутентификация:**
   - Передача подписи в метаданных gRPC
   - Проверка подписи на сервере

4. **Потоковая передача данных:**
   - Использование потоковой отправки метрик (streaming) для улучшения производительности
   - Эффективная обработка большого количества метрик без создания множества соединений

### 6. Переключение между HTTP и gRPC

Для обеспечения обратной совместимости и плавного перехода на gRPC:

1. **Параллельная работа HTTP и gRPC серверов:**
   - HTTP сервер продолжает работать на порту, указанном в `-a` или `ADDRESS`
   - gRPC сервер запускается на порту, указанном в `-grpc-address` или `GRPC_ADDRESS`

2. **Выбор протокола на стороне агента:**
   - Если `-grpc-enabled` или `GRPC_ENABLED` установлен в `true`, агент использует gRPC
   - В противном случае агент продолжает использовать HTTP

3. **Фабрика клиентов:**
   - Создание интерфейса `MetricsClient` с реализациями для HTTP и gRPC
   - Выбор реализации в зависимости от конфигурации

4. **Команды в Makefile:**
   - `make server-with-grpc` - запуск сервера с поддержкой gRPC
   - `make agent-with-grpc` - запуск агента с использованием gRPC

## Преимущества использования gRPC

1. **Производительность:**
   - Более эффективная сериализация данных (Protocol Buffers вместо JSON)
   - Меньший размер передаваемых данных
   - Использование HTTP/2 для мультиплексирования запросов

2. **Надежность:**
   - Строгая типизация данных
   - Автоматическая генерация клиентского и серверного кода
   - Встроенная поддержка повторных попыток и таймаутов

3. **Расширяемость:**
   - Легкое добавление новых методов и типов данных
   - Поддержка потоковой передачи данных

## Реализация потоковой передачи метрик

### Преимущества потоковой передачи

1. **Эффективность:**
   - Уменьшение накладных расходов на установку соединения
   - Снижение задержек при отправке большого количества метрик
   - Более эффективное использование сетевых ресурсов

2. **Масштабируемость:**
   - Возможность обрабатывать больший объем метрик без увеличения нагрузки на сеть
   - Лучшая работа при большом количестве агентов

### Принцип работы потоковой передачи

1. **На стороне агента:**
   - Агент собирает метрики с определенным интервалом (poll_interval, например 2-10 секунд)
   - С другим интервалом (report_interval, например 10-30 секунд) агент открывает поток для отправки накопленных метрик
   - Все накопленные за период метрики отправляются пакетом через открытый поток
   - После отправки всех накопленных метрик агент закрывает поток и получает ответ

2. **На стороне сервера:**
   - Сервер принимает поток метрик от агента
   - Метрики группируются в пакеты для эффективного сохранения
   - После закрытия потока сервер отправляет ответ агенту

## Заключение

Внедрение gRPC в проект go-metrics позволит улучшить производительность, надежность и расширяемость системы сбора метрик. Параллельная поддержка HTTP и gRPC обеспечит обратную совместимость и плавный переход на новый протокол.

План реализации включает создание proto-файлов, добавление параметров конфигурации, реализацию gRPC сервера и клиента, а также использование дополнительных возможностей gRPC, таких как сжатие, шифрование и потоковая передача данных.

Особое внимание уделено потоковой передаче метрик, которая позволит значительно повысить эффективность работы системы при большом количестве метрик и агентов. 