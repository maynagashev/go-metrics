# Спецификация проекта go-metrics

## Описание

Сервис для сбора и хранения метрик. Состоит из серверной части и агента.

## Компоненты системы

### Сервер

- Принимает, хранит и отдает метрики
- Поддерживает работу с PostgreSQL
- Сохраняет метрики на диск (опционально)
- Поддерживает сжатие данных (gzip)
- Проверяет подпись данных по алгоритму SHA256

#### Основные эндпоинты

- `POST /update` - обновление одной метрики (JSON формат)
- `POST /updates/` - пакетное обновление метрик
- `POST /value` - получение значения метрики
- `GET /ping` - проверка соединения с БД

### Агент

- Собирает метрики из runtime (GC, Memory, CPU)
- Собирает системные метрики используя gopsutil:
  - TotalMemory
  - FreeMemory
  - CPUutilization
- Отправляет метрики на сервер пакетами
- Поддерживает ограничение количества одновременных запросов
- Использует сжатие данных
- Подписывает данные по алгоритму SHA256

## Конфигурация

### Настройки сервера

Флаги командной строки и переменные окружения:

- `-d`, `DATABASE_DSN` - строка подключения к PostgreSQL
- `-f`, `FILE_STORAGE_PATH` - путь к файлу для сохранения метрик
- `-i`, `STORE_INTERVAL` - интервал сохранения метрик на диск
- `-r`, `RESTORE` - загружать ли сохраненные метрики при старте
- `-k`, `KEY` - ключ для подписи данных

### Настройки агента

Флаги командной строки и переменные окружения:

- `-k`, `KEY` - ключ для подписи данных
- `-l`, `RATE_LIMIT` - ограничение количества одновременных запросов

## Хранение данных

- Основное хранилище: PostgreSQL
- Резервное хранилище: файловая система (опционально)

## Безопасность

- Подпись данных по алгоритму SHA256
- Проверка подписи на сервере
- Отбрасывание данных при несовпадении подписи

## Отказоустойчивость

- Повторные попытки при ошибках соединения
- Интервалы между повторами: 1s, 3s, 5s
- Обработка ошибок доступа к БД
- Обработка ошибок доступа к файлам

## Производительность

- Сжатие данных при передаче
- Пакетная отправка метрик
- Ограничение количества одновременных запросов
- Многопоточная обработка на агенте

## Разработка

- Использование golang-migrate для миграций БД
- Makefile для автоматизации задач
- Покрытие тестами не менее 40%
- Линтинг кода
