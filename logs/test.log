?   	github.com/maynagashev/go-metrics/internal/config	[no test files]
?   	github.com/maynagashev/go-metrics/internal/grpc/pb	[no test files]
=== RUN   TestAgentEncryption
--- PASS: TestAgentEncryption (0.00s)
=== RUN   TestLoadJSONConfig
--- PASS: TestLoadJSONConfig (0.00s)
=== RUN   TestApplyJSONConfig
--- PASS: TestApplyJSONConfig (0.00s)
=== RUN   TestMustParseFlags
=== RUN   TestMustParseFlags/default_values
=== RUN   TestMustParseFlags/command_line_arguments
=== RUN   TestMustParseFlags/environment_variables_override
=== RUN   TestMustParseFlags/invalid_report_interval_env
=== RUN   TestMustParseFlags/invalid_poll_interval_env
=== RUN   TestMustParseFlags/invalid_rate_limit_env
=== RUN   TestMustParseFlags/rate_limit_less_than_1
=== RUN   TestMustParseFlags/minimum_intervals
--- PASS: TestMustParseFlags (0.00s)
    --- PASS: TestMustParseFlags/default_values (0.00s)
    --- PASS: TestMustParseFlags/command_line_arguments (0.00s)
    --- PASS: TestMustParseFlags/environment_variables_override (0.00s)
    --- PASS: TestMustParseFlags/invalid_report_interval_env (0.00s)
    --- PASS: TestMustParseFlags/invalid_poll_interval_env (0.00s)
    --- PASS: TestMustParseFlags/invalid_rate_limit_env (0.00s)
    --- PASS: TestMustParseFlags/rate_limit_less_than_1 (0.00s)
    --- PASS: TestMustParseFlags/minimum_intervals (0.00s)
=== RUN   TestMain
Build version: N/A
Build date: N/A
Build commit: N/A
time=2025-03-21T01:59:16.635+07:00 level=DEBUG msg="parsed flags and env variables" flags="{Server:{Addr:localhost:9090 ReportInterval:5 PollInterval:2} PrivateKey:test-key CryptoKey: RateLimit:5 EnablePprof:false PprofPort:6060 ConfigFile: RealIP: GRPCAddress:localhost:9090 GRPCEnabled:false GRPCTimeout:5 GRPCRetry:3}"
--- PASS: TestMain (0.00s)
=== RUN   TestInitLogger
time=2025-03-21T01:59:16.636+07:00 level=DEBUG msg="test message"
--- PASS: TestInitLogger (0.00s)
=== RUN   TestPrintVersion
--- PASS: TestPrintVersion (0.00s)
=== RUN   TestPrintVersionDefaultValues
--- PASS: TestPrintVersionDefaultValues (0.00s)
=== RUN   TestInitPprof
=== RUN   TestInitPprof/profiling_disabled
=== RUN   TestInitPprof/profiling_enabled
--- PASS: TestInitPprof (0.21s)
    --- PASS: TestInitPprof/profiling_disabled (0.10s)
    --- PASS: TestInitPprof/profiling_enabled (0.10s)
=== RUN   TestStartPProf
=== RUN   TestStartPProf/empty_address
=== RUN   TestStartPProf/valid_address
--- PASS: TestStartPProf (0.20s)
    --- PASS: TestStartPProf/empty_address (0.10s)
    --- PASS: TestStartPProf/valid_address (0.10s)
=== RUN   TestStartPProf_ServerError
time=2025-03-21T01:59:17.149+07:00 level=ERROR msg="Failed to start pprof server" error="listen tcp 127.0.0.1:9996: bind: address already in use"
--- PASS: TestStartPProf_ServerError (0.21s)
=== RUN   Example_jsonConfig
--- PASS: Example_jsonConfig (0.00s)
PASS
ok  	github.com/maynagashev/go-metrics/cmd/agent	0.644s
=== RUN   TestGenerateKeyPair
2025/03/20 23:57:06 INFO Генерация RSA ключей bits=2048
--- PASS: TestGenerateKeyPair (0.67s)
=== RUN   TestParseFlags
--- PASS: TestParseFlags (0.00s)
=== RUN   TestGetStringOrDefault
--- PASS: TestGetStringOrDefault (0.00s)
=== RUN   TestPrintVersion
--- PASS: TestPrintVersion (0.00s)
=== RUN   TestInitLogger
--- PASS: TestInitLogger (0.00s)
=== RUN   TestMain
time=2025-03-20T23:57:07.318+07:00 level=INFO msg="Build information" version=N/A date=N/A commit=N/A
--- PASS: TestMain (0.30s)
PASS
ok  	github.com/maynagashev/go-metrics/cmd/keygen	(cached)
=== RUN   TestRun
=== RUN   TestRun/empty_dsn
=== RUN   TestRun/empty_migrations_path
--- PASS: TestRun (0.00s)
    --- PASS: TestRun/empty_dsn (0.00s)
    --- PASS: TestRun/empty_migrations_path (0.00s)
=== RUN   TestMain_Integration
=== RUN   TestMain_Integration/no_args
=== RUN   TestMain_Integration/only_dsn
/tmp/go-build796955045/b302/migrate.test flag redefined: d
=== RUN   TestMain_Integration/only_migrations_path
/tmp/go-build796955045/b302/migrate.test flag redefined: d
--- PASS: TestMain_Integration (0.00s)
    --- PASS: TestMain_Integration/no_args (0.00s)
    --- PASS: TestMain_Integration/only_dsn (0.00s)
    --- PASS: TestMain_Integration/only_migrations_path (0.00s)
PASS
ok  	github.com/maynagashev/go-metrics/cmd/migrate	(cached)
=== RUN   TestPrintVersion
--- PASS: TestPrintVersion (0.00s)
=== RUN   TestInitLogger
--- PASS: TestInitLogger (0.00s)
=== RUN   TestInitStorage
=== RUN   TestInitStorage/MemoryStorage
2025-03-21T01:59:16.631+0700	DEBUG	memory/memory.go:37	memory storage created	{"storage": {}}
--- PASS: TestInitStorage (0.00s)
    --- PASS: TestInitStorage/MemoryStorage (0.00s)
PASS
ok  	github.com/maynagashev/go-metrics/cmd/server	0.016s
=== RUN   TestLoadConfig
2025/03/20 23:57:06 Конфигурационный файл не найден
2025/03/20 23:57:06 Ошибка при чтении конфигурационного файла: invalid character 'i' looking for beginning of object key string
--- PASS: TestLoadConfig (0.00s)
=== RUN   TestAddAnalyzers
2025/03/20 23:57:06 Используются все анализаторы staticcheck (секция отсутствует в конфигурации)
2025/03/20 23:57:06 Используются анализаторы staticcheck из конфигурационного файла: [SA1000]
--- PASS: TestAddAnalyzers (0.00s)
=== RUN   TestGetAllStaticcheckAnalyzers
--- PASS: TestGetAllStaticcheckAnalyzers (0.00s)
=== RUN   TestGetAllStylecheckAnalyzers
--- PASS: TestGetAllStylecheckAnalyzers (0.00s)
PASS
ok  	github.com/maynagashev/go-metrics/cmd/staticlint	(cached)
?   	github.com/maynagashev/go-metrics/internal/server/storage/pgstorage/migration	[no test files]
=== RUN   TestAnalyzer
--- PASS: TestAnalyzer (1.51s)
PASS
ok  	github.com/maynagashev/go-metrics/cmd/staticlint/passes/errcheck	1.536s
=== RUN   TestAnalyzer
--- PASS: TestAnalyzer (1.55s)
PASS
ok  	github.com/maynagashev/go-metrics/cmd/staticlint/passes/noexit	1.583s
=== RUN   Example_update
--- PASS: Example_update (0.01s)
=== RUN   Example_getValue
--- PASS: Example_getValue (0.12s)
=== RUN   Example_updateBatch
--- PASS: Example_updateBatch (0.01s)
=== RUN   Example_ping
--- PASS: Example_ping (0.01s)
PASS
ok  	github.com/maynagashev/go-metrics/example	(cached)
=== RUN   TestAgent_collectRuntimeMetrics
2025/03/21 01:59:16 INFO using HTTP client address=http://localhost:8080/metrics
=== RUN   TestAgent_collectRuntimeMetrics/collect_runtime_metrics
2025/03/21 01:59:16 INFO Preparing metrics for sending gauges_count=27 counters_count=0 poll_count=0
--- PASS: TestAgent_collectRuntimeMetrics (0.00s)
    --- PASS: TestAgent_collectRuntimeMetrics/collect_runtime_metrics (0.00s)
=== RUN   TestAgent_GRPCConfig
2025/03/21 01:59:16 INFO Starting agent server_url=http://localhost:8080/metrics poll_interval=2s report_interval=10s private_key=<empty> rate_limit=0 grpc_enabled=false grpc_address=localhost:9090
2025/03/21 01:59:16 INFO ======= GRACEFUL SHUTDOWN STARTED =======
2025/03/21 01:59:16 INFO Tickers stopped
2025/03/21 01:59:16 INFO Stop channel closed
2025/03/21 01:59:16 INFO Shutdown signal received while preparing metrics - ensuring final metrics are sent gauges_count=27 counters_count=1 poll_count=0
2025/03/21 01:59:16 INFO Sending final metrics batch before shutdown count=28
    agent_test.go:77: Test completed successfully
--- PASS: TestAgent_GRPCConfig (0.00s)
=== RUN   TestAgent_CollectRuntimeMetrics
2025/03/21 01:59:16 INFO using HTTP client address=http://localhost:8080
2025/03/21 01:59:16 INFO Preparing metrics for sending gauges_count=27 counters_count=0 poll_count=0
--- PASS: TestAgent_CollectRuntimeMetrics (0.00s)
=== RUN   TestAgent_CollectAdditionalMetrics
2025/03/21 01:59:16 INFO sending metrics batch (try=0) url=http://localhost:8080/metrics/updates metrics="[Metric{Name: OtherSys, Type: gauge, Value: 746877.000000} Metric{Name: Sys, Type: gauge, Value: 6904848.000000} Metric{Name: Alloc, Type: gauge, Value: 682864.000000} Metric{Name: Mallocs, Type: gauge, Value: 2631.000000} Metric{Name: PauseTotalNs, Type: gauge, Value: 0.000000} Metric{Name: TotalAlloc, Type: gauge, Value: 682864.000000} Metric{Name: GCSys, Type: gauge, Value: 1875256.000000} Metric{Name: HeapSys, Type: gauge, Value: 3735552.000000} Metric{Name: MSpanInuse, Type: gauge, Value: 35040.000000} Metric{Name: NumForcedGC, Type: gauge, Value: 0.000000} Metric{Name: NumGC, Type: gauge, Value: 0.000000} Metric{Name: LastGC, Type: gauge, Value: 0.000000} Metric{Name: Lookups, Type: gauge, Value: 0.000000} Metric{Name: StackSys, Type: gauge, Value: 458752.000000} Metric{Name: HeapIdle, Type: gauge, Value: 2162688.000000} Metric{Name: HeapObjects, Type: gauge, Value: 2450.000000} Metric{Name: MCacheInuse, Type: gauge, Value: 24000.000000} Metric{Name: MSpanSys, Type: gauge, Value: 48960.000000} Metric{Name: NextGC, Type: gauge, Value: 4194304.000000} Metric{Name: GCCPUFraction, Type: gauge, Value: 0.000000} Metric{Name: HeapAlloc, Type: gauge, Value: 682864.000000} Metric{Name: HeapReleased, Type: gauge, Value: 2162688.000000} Metric{Name: BuckHashSys, Type: gauge, Value: 8251.000000} Metric{Name: Frees, Type: gauge, Value: 181.000000} Metric{Name: StackInuse, Type: gauge, Value: 458752.000000} Metric{Name: HeapInuse, Type: gauge, Value: 1572864.000000} Metric{Name: MCacheSys, Type: gauge, Value: 31200.000000} Metric{Name: PollCount, Type: counter, Delta: 0}]"
2025/03/21 01:59:16 INFO using HTTP client address=http://localhost:8080
2025/03/21 01:59:16 INFO Collector started
2025/03/21 01:59:16 INFO Stop signal received, collector exiting
2025/03/21 01:59:16 INFO Report routine started report_interval=10s server_url=http://localhost:8080/metrics grpc_enabled=false grpc_address=localhost:9090
2025/03/21 01:59:16 INFO Client initialized client_type=*http.Client
2025/03/21 01:59:16 INFO Stopping reports due to context cancellation
2025/03/21 01:59:16 INFO Poll routine started poll_interval=2s metrics_storage_size=28
2025/03/21 01:59:16 INFO Stopping polls due to agent shutdown
2025/03/21 01:59:16 INFO Preparing metrics for sending gauges_count=22 counters_count=0 poll_count=0
--- PASS: TestAgent_CollectAdditionalMetrics (0.00s)
=== RUN   TestAgent_GetMetrics
2025/03/21 01:59:16 INFO using HTTP client address=http://localhost:8080
2025/03/21 01:59:16 INFO Preparing metrics for sending gauges_count=49 counters_count=0 poll_count=0
--- PASS: TestAgent_GetMetrics (0.00s)
=== RUN   TestAgent_ResetMetrics
2025/03/21 01:59:16 INFO using HTTP client address=http://localhost:8080
2025/03/21 01:59:16 INFO Preparing metrics for sending gauges_count=49 counters_count=0 poll_count=0
2025/03/21 01:59:16 INFO Preparing metrics for sending gauges_count=0 counters_count=0 poll_count=0
--- PASS: TestAgent_ResetMetrics (0.00s)
=== RUN   TestAgent_IsRequestSigningEnabled
2025/03/21 01:59:16 INFO using HTTP client address=http://localhost:8080
2025/03/21 01:59:16 INFO using HTTP client address=http://localhost:8080
--- PASS: TestAgent_IsRequestSigningEnabled (0.00s)
=== RUN   TestAgent_IsEncryptionEnabled
2025/03/21 01:59:16 INFO using HTTP client address=http://localhost:8080
--- PASS: TestAgent_IsEncryptionEnabled (0.00s)
=== RUN   TestGetOutboundIP
--- PASS: TestGetOutboundIP (0.00s)
=== RUN   TestWorker
=== RUN   TestWorker/Успешная_обработка_задания
=== RUN   TestWorker/Обработка_ошибки_из_sendMetrics
=== RUN   TestWorker/Обработка_закрытой_очереди_отправки
=== RUN   TestWorker/Обработка_сигнала_остановки
=== RUN   TestWorker/Обработка_сигнала_остановки_во_время_отправки_результата
2025/03/21 01:59:16.755571 DEBUG RESTY 
==============================================================================
~~~ REQUEST ~~~
POST  /metrics/updates  HTTP/1.1
HOST   : localhost:8080
HEADERS:
	Accept: application/json
	Content-Encoding: gzip
	Content-Type: application/json
	User-Agent: go-resty/2.12.0 (https://github.com/go-resty/resty)
	X-Real-Ip: 100.64.19.228
BODY   :
"H4sIAAAAAAAC/5SUy2rrMBCG30VrLyxZkpXszjHkAs2Fpl2VLqbykKRRLGNLpaH03YtDsWOohbMMfBP0f/OPX77IMSdTsnEHrHaXmkTEXUokU7IHv0cSkQ8wHsk05VKl6Xf0y4dQOYm54qpl/xlj9TCtmJK8hVfQ0MN/zmRCW3gLvsYn68CshyfiFr+Sd71mnoWCUpUKJmRLLxDKEJ+kiRCCdVl3JRTLwtc4PCJi3gVY+/PMVhrzeTYi7tqfR3EPULtxoLUnX44xvXOgTyEVXDTueuaWuRn2wKhkUqnewObtHbULVIWL7kWrDPQBw7IZj+O4v51gBjWRN7bxM2SR0wlP4ttmZdvnWQXaHW0xwmgT+K7qNgOPaBBqzEdr/e/1aQH1IRRbMdFd4KxCDB0I7Vci7P+vUgQHqEj7H4/rkoMnSNnNirfWmMz6wnW8bn5iRSKSo3HQrOD1JwAA//+4i/BsJQUAAA=="

------------------------------------------------------------------------------
~~~ RESPONSE ~~~
STATUS       : 404 Not Found
PROTO        : HTTP/1.1
RECEIVED AT  : 2025-03-21T01:59:16.755397391+07:00
TIME DURATION: 7.210334ms
HEADERS      :
	Content-Length: 19
	Content-Type: text/plain; charset=utf-8
	Date: Thu, 20 Mar 2025 18:59:16 GMT
	X-Content-Type-Options: nosniff
BODY         :
404 page not found
==============================================================================
2025/03/21 01:59:16 ERROR failed to send metrics (try=0): server returned non-OK response: 404 metrics="[Metric{Name: OtherSys, Type: gauge, Value: 746877.000000} Metric{Name: Sys, Type: gauge, Value: 6904848.000000} Metric{Name: Alloc, Type: gauge, Value: 682864.000000} Metric{Name: Mallocs, Type: gauge, Value: 2631.000000} Metric{Name: PauseTotalNs, Type: gauge, Value: 0.000000} Metric{Name: TotalAlloc, Type: gauge, Value: 682864.000000} Metric{Name: GCSys, Type: gauge, Value: 1875256.000000} Metric{Name: HeapSys, Type: gauge, Value: 3735552.000000} Metric{Name: MSpanInuse, Type: gauge, Value: 35040.000000} Metric{Name: NumForcedGC, Type: gauge, Value: 0.000000} Metric{Name: NumGC, Type: gauge, Value: 0.000000} Metric{Name: LastGC, Type: gauge, Value: 0.000000} Metric{Name: Lookups, Type: gauge, Value: 0.000000} Metric{Name: StackSys, Type: gauge, Value: 458752.000000} Metric{Name: HeapIdle, Type: gauge, Value: 2162688.000000} Metric{Name: HeapObjects, Type: gauge, Value: 2450.000000} Metric{Name: MCacheInuse, Type: gauge, Value: 24000.000000} Metric{Name: MSpanSys, Type: gauge, Value: 48960.000000} Metric{Name: NextGC, Type: gauge, Value: 4194304.000000} Metric{Name: GCCPUFraction, Type: gauge, Value: 0.000000} Metric{Name: HeapAlloc, Type: gauge, Value: 682864.000000} Metric{Name: HeapReleased, Type: gauge, Value: 2162688.000000} Metric{Name: BuckHashSys, Type: gauge, Value: 8251.000000} Metric{Name: Frees, Type: gauge, Value: 181.000000} Metric{Name: StackInuse, Type: gauge, Value: 458752.000000} Metric{Name: HeapInuse, Type: gauge, Value: 1572864.000000} Metric{Name: MCacheSys, Type: gauge, Value: 31200.000000} Metric{Name: PollCount, Type: counter, Delta: 0}]"
2025/03/21 01:59:16 ERROR Failed to send final metrics directly error="server returned non-OK response: 404"
2025/03/21 01:59:16 ERROR Failed to queue final metrics, queue might be full
2025/03/21 01:59:16 INFO Closing send queue
2025/03/21 01:59:16 INFO Waiting for all goroutines to finish
2025/03/21 01:59:16 INFO ======= GRACEFUL SHUTDOWN COMPLETED =======
--- PASS: TestWorker (0.10s)
    --- PASS: TestWorker/Успешная_обработка_задания (0.00s)
    --- PASS: TestWorker/Обработка_ошибки_из_sendMetrics (0.00s)
    --- PASS: TestWorker/Обработка_закрытой_очереди_отправки (0.00s)
    --- PASS: TestWorker/Обработка_сигнала_остановки (0.00s)
    --- PASS: TestWorker/Обработка_сигнала_остановки_во_время_отправки_результата (0.10s)
=== RUN   TestCollector
=== RUN   TestCollector/Успешная_обработка_результатов
=== RUN   TestCollector/Обработка_закрытой_очереди_результатов
=== RUN   TestCollector/Обработка_сигнала_остановки
--- PASS: TestCollector (0.10s)
    --- PASS: TestCollector/Успешная_обработка_результатов (0.10s)
    --- PASS: TestCollector/Обработка_закрытой_очереди_результатов (0.00s)
    --- PASS: TestCollector/Обработка_сигнала_остановки (0.00s)
PASS
ok  	github.com/maynagashev/go-metrics/internal/agent	0.232s
